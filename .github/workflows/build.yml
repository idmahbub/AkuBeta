name: Cross Platform Build & Release with Auto Tag

on:
  push:
    branches: [master]
  workflow_dispatch:

jobs:
  build-and-release:
    strategy:
      matrix:
        os: [windows-latest, macos-latest, ubuntu-latest]
    runs-on: ${{ matrix.os }}

    steps:
      # ================== Checkout ==================
      - name: Checkout repository
        uses: actions/checkout@v4

      # ================== Auto version tagging ==================
      - name: Set version tag
        id: version
        run: |
          # Ambil tag terakhir
          last_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "Last tag: $last_tag"

          # Ambil angka versi terakhir
          IFS='.' read -r major minor patch <<<"${last_tag#v}"
          patch=$((patch + 1))
          new_tag="v$major.$minor.$patch"
          echo "New tag: $new_tag"

          # Buat tag
          git tag $new_tag
          git push origin $new_tag

          echo "tag=$new_tag" >> $GITHUB_OUTPUT
        shell: bash

      # ================== Setup Python ==================
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # ================== Install dependencies ==================
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt pyinstaller

      # ================== FFmpeg ==================
      - name: Install FFmpeg
        run: |
          mkdir -p bin
          if [ "$RUNNER_OS" == "macOS" ]; then
            brew install ffmpeg
            cp $(which ffmpeg) bin/
            cp $(which ffprobe) bin/
          elif [ "$RUNNER_OS" == "Linux" ]; then
            sudo apt update
            sudo apt install -y ffmpeg
            cp $(which ffmpeg) bin/
            cp $(which ffprobe) bin/
          fi
        shell: bash
        if: runner.os != 'Windows'

      - name: Download FFmpeg (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          if (!(Test-Path bin)) { New-Item -ItemType Directory -Path bin }
          curl -L -o ffmpeg.zip https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip
          Expand-Archive ffmpeg.zip -DestinationPath ffmpeg
          $ffmpeg = Get-ChildItem ffmpeg | Select-Object -First 1
          Copy-Item "$ffmpeg\bin\ffmpeg.exe" bin\
          Copy-Item "$ffmpeg\bin\ffprobe.exe" bin\

      # ================== yt-dlp ==================
      - name: Download yt-dlp
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            curl -L -o bin/yt-dlp.exe https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp.exe
          else
            curl -L -o bin/yt-dlp https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp
            chmod +x bin/yt-dlp
          fi
        shell: bash

      # ================== Build app ==================
      - name: Build app
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            pyinstaller app.py --onefile --windowed --name PlaylistApp --add-data "fonts;fonts" --add-data "bin;bin"
          else
            pyinstaller app.py --onefile --windowed --name PlaylistApp --add-data "fonts:fonts" --add-data "bin:bin"
          fi
        shell: bash

      # ================== Rename build ==================
      - name: Rename build
        run: |
          if [ "$RUNNER_OS" == "macOS" ]; then
            mv dist/PlaylistApp dist/PlaylistApp-macOS
          elif [ "$RUNNER_OS" == "Linux" ]; then
            mv dist/PlaylistApp dist/PlaylistApp-Linux
          fi
        shell: bash
        if: runner.os != 'Windows'

      - name: Rename Windows build
        shell: powershell
        if: runner.os == 'Windows'
        run: ren dist\PlaylistApp.exe PlaylistApp-Windows.exe

      # ================== Zip / tar ==================
      - name: Package build
        run: |
          if [ "$RUNNER_OS" == "macOS" ]; then
            zip -r dist/PlaylistApp-macOS.zip dist/PlaylistApp-macOS.app
          elif [ "$RUNNER_OS" == "Linux" ]; then
            tar -czf dist/PlaylistApp-Linux.tar.gz dist/PlaylistApp-Linux
          fi
        shell: bash
        if: runner.os != 'Windows'

      - name: Package Windows build
        shell: powershell
        if: runner.os == 'Windows'
        run: Compress-Archive -Path dist\PlaylistApp-Windows.exe -DestinationPath dist\PlaylistApp-Windows.zip

      # ================== Upload to GitHub Release ==================
      - name: Create / Upload GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Release ${{ steps.version.outputs.tag }}
          files: |
            dist/PlaylistApp-Windows.zip
            dist/PlaylistApp-macOS.zip
            dist/PlaylistApp-Linux.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
